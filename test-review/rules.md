# rules.md — テストケースレビュー運用ルール

この文書は、LLM に「利用手順書/仕様書/要件定義書（以下、元ドキュメント）」と「作成済みテストケース（CSV）」を渡し、テストケースレビューを均質化するための大枠ルールを定める。

## 関連ドキュメント

* **`test_viewpoint_identify_guide.md`**: テスト観点抽出の詳細手順とプロンプトテンプレート
* **`test_review_guide.md`**: テストケースレビューの詳細手順とプロンプトテンプレート

本ドキュメントは全体のルールと基準を定義し、詳細な手順は上記ガイドを参照すること。

---

## 1. ゴールとアウトプット定義

* ゴール:
  * 元ドキュメントの要求を前提に、テストケース（CSV）が**妥当で、欠落が少なく、再利用しやすい**かを判定する。
* レビュー結果の最終アウトプット（必須要素）:
  * **総合評価**: `S / A / B / C / D`
  * **採点（各100点満点）**:
    * 網羅性
    * 粒度
    * 有効性
    * 非機能の組み込み
    * 再利用性
  * **問題点の指摘**（根拠と参照情報つき）
  * **次のアクション**（優先度・担当・粒度）
* 出力: Markdownファイル（2ファイル）。フォーマットおよび詳細テンプレートは §6 を参照。

---

## 2. 前提入力と前処理

* 入力:
  1. 元ドキュメント（複数可、版数/日付つき）
  2. テストケース CSV（列名例: `ID, Features, Title, Preconditions, Steps, Expected Results, Notes, Test Type` など）
  3. ユーザーからの**重点レビュー観点**（任意。例: 「異常系の網羅と再利用性を重視」）
* 前処理（LLM側の自己チェック）:
  * 版数や適用スコープの不一致がないか確認。
  * CSV の列構造を読み取り、フィールド欠落や表記ゆれを検出。
  * 同一 ID の重複、未使用 ID の飛び番、空行やダミー行の混入を検出。
  * **テスト観点抽出**: `test_viewpoint_identify_guide.md` に従って、元ドキュメントからテスト観点（正常/準正常/異常、非機能）を体系的に抽出し、後続のレビューで使用する。抽出結果は **`test-viewpoint-list.md`** として出力する。

---

## 3. 採点基準（100点満点 × 5項目）

### 3.1 網羅性

* 仕様・要件・制約・例外・業務フローの**必須観点**がテストケースに反映されている割合。
* 正常系/準正常系/異常系の**偏り**が小さいこと。

### 3.2 粒度

* 1ケース=1観点（または一貫した小さな目的）であること。
* 冗長な操作列や、複数観点の抱き合わせを避け、**読み替え可能**な単位であること。

### 3.3 有効性

* リスクの高い領域・回帰しやすい領域・変更影響の大きい領域を**優先**できているか。
* 期待結果が**可観測**（観測可能で曖昧でない）で、失敗時に原因が追えること。

### 3.4 非機能の組み込み

* パフォーマンス、セキュリティ、操作性、可用性、ログ/監査、アクセシビリティなど、**対象に相応しい非機能観点**がテスト設計に織り込まれているか。

### 3.5 再利用性

* 画面文言・並び順・固定値に依存しすぎず、**データ駆動**やプレースホルダで抽象化されているか。
* 前提条件・後処理が整理され、他シナリオへ**転用**しやすいか。

---

## 4. スコア算出と総合評価

* デフォルト重み: すべて同一重み（各20%）。
* 重点レビュー観点が指定された場合、その項目の重みを上げて再計算してもよい（例: 指定項目 30%、残り均等）。
* 総合評価ランク決定（例）:
  * **S**: 平均≥90 かつ全項目≥85
  * **A**: 平均80–89
  * **B**: 平均70–79
  * **C**: 平均60–69
  * **D**: 平均<60
* 重要: ランクは**根拠つき**で説明すること（どの欠落/偏りが何点に影響したか）。

---

## 5. レビュー手順（高レベル）

1. **整合性チェック**: 入力の版/適用範囲/用語を整える。矛盾は都度メモ。
2. **観点抽出**: `test_viewpoint_identify_guide.md` に沿ってテスト観点を抽出。
3. **観点対照表の作成**: 抽出した観点リストと、CSV のケースを**1:多**でマッピング（詳細は `test_review_guide.md` §4 を参照）。
4. **ギャップ分析**: 未カバー観点、重複ケース、偏り（正常系過多など）を可視化。
5. **品質評価**: §3 の各基準で採点。リスクや優先度との整合も確認。
6. **改善提案**: ケース統合/分割、期待結果の可観測化、非機能の追加、データ駆動化など、**具体的**な次アクションを起票。
7. **出力整形**: `test_review_guide.md` §7 のテンプレートで Markdown を生成。参照根拠を**行番号/節番号**で示す。

---

## 6. 出力テンプレート

* 出力形式: **Markdown** 固定。
* 出力ファイル（2ファイル必須）:
  * **`test-review-result.md`**: `test_review_guide.md` に従って実施されたレビュー結果。詳細なテンプレートは `test_review_guide.md` §7 を参照。
  * **`test-viewpoint-list.md`**: レビューの過程で `test_viewpoint_identify_guide.md` に従って作成されたテスト観点の一覧。テンプレートは `test_viewpoint_identify_guide.md` §6 を参照。

---

## 7. ルール（振る舞いと制約）

* **根拠主義**: 指摘は必ず出典（節/項/表/図/行）を併記。推測は推測と明示。
* **非ハルシネーション**: 元ドキュメントにない仕様は**提案**として扱い、事実として断言しない。
* **優先度駆動**: リスク・影響・頻度を加味し、改善提案は優先度付きで並べる。
* **再現性**: 同じ入力で同じ出力構造になるよう、見出し・箇条書き・表のレイアウトを固定。
* **表記ゆれ抑制**: 用語集/定義を冒頭で確定し、以降は統一。
* **倫理と実務**: 本番データや個人情報が含まれる例はマスク表記にする。

---

## 8. よくある欠陥パターン

* 詳細な欠陥パターンと検出ルールは `test_review_guide.md` §6 を参照。
* 主なパターン: 期待結果の曖昧さ、抱き合わせ、正常偏重、非機能の分離依存、固定値/文言依存、前提不足など。

---

## 9. CSV 取り扱いの注意

* 列が不足する場合は、`Type`（Normal/Quasi/Abnormal/NonFunctional）や `Tags` を補完提案。
* `Expected` が曖昧なケースは、**観測点**（UI/ログ/DB/API/メトリクス）に分解して提案。
* 大規模 CSV は、まず統計（件数、Type 構成比、重複率、未参照観点数）をサマリ表示。

---

## 10. シナリオテストへの配慮

* 単機能の連なりではなく、**ユーザーストーリー/業務フロー**の目標達成を軸に設計されているか確認。
* 途中の**分岐/代替フロー/例外**がテストパスに反映されているか。

---

## 11. 運用ノート

* 重点観点や重みの変更は、レビュー冒頭のメタ情報として必ず記録。
* しきい値やランク基準を見直す場合は、本ファイルの版数を更新。
* チームは本テンプレートの**逸脱理由**を記録し、次回にフィードバックする。

---

## 12. 付録 — ミニ用語集

* **準正常系**: 想定内エラーや境界近傍など、回復可能で事業上起こり得る挙動。
* **観測可能性**: 期待結果が、UI/ログ/DB/API/メトリクスなどで検証可能である性質。
* **データ駆動**: テストロジックとデータを分離し、テーブルや外部ファイルでケースを展開する設計。
