# LLMによる業務シナリオテスト設計の運用ルール

## 1. 目的と適用範囲

* **目的**：利用手順書／仕様書／要件定義書（以下「ソース文書」）から、再現性高く**テスト観点**を抽出し、それらを網羅しつつ実務の流れを意識した**業務シナリオ**を設計するための運用ルールを定める。
* **適用範囲**：Web/Windows/モバイル等のエンドユーザー操作型アプリケーションを対象。個別ドメインの特殊論点は後述の「ドメイン付帯ルール」で拡張する。

## 2. 用語

* **テスト観点**：ソース文書から抽出した、確認すべき性質・条件・動作。
  * **分類（test_class）**：`normal`（正常）／`quasi`（準正常：想定内の誤り・回復）／`abnormal`（異常：想定外）
  * **リスク**：影響×発生可能性で評価（1〜5）。詳細説明を付与。
* **業務シナリオ**：複数の観点を**ユーザーストーリー**や**業務フロー**に沿って束ねた、終端条件までの一連の検証ストーリー。単機能チェックの羅列は禁止。

## 3. 入力と成果物


### 入力（LLMへ与えるもの）

* ソース文書（必須）：利用手順書／仕様書／要件定義書（章・節・ページの参照可能な識別子を付与）
* 制約・前提（任意）：対象環境、対象ロール、非対象範囲、既知の制約
* 非機能の着目点（任意）：性能・セキュリティ・アクセシビリティ等のヒント

### 成果物（LLMが出力するもの）

1. **観点リスト**（Phase 1の最終アウトプット）
2. **業務シナリオリスト**（Phase 2の最終アウトプット）
   両方ともMarkdownで出力する。
3. **優先実行シナリオ**の要約（Top N）

## 4. 実行フェーズ

### Phase 1：テスト観点の抽出

1. **範囲の確定**：本件の対象スコープ・ロール・非対象を要約（100〜150字目安）。
2. **アクターと主機能の特定**：アクター（例：一般ユーザー、管理者）と主機能群を列挙。
3. **観点の初期抽出**：
   * ソース文書を章節単位で走査し、**確認観点**を抽出。
   * 各観点に**出典（doc_id, section_id, page）**を必ず紐付ける。
4. **分類と構造化**：
   * `test_class` を `normal` / `quasi` / `abnormal` のいずれかで付与。
   * 関連機能・前提条件・期待結果の要点を記述。
5. **リスク評価**：
   * `risk_score`（1〜5）＝ `impact`（1〜5）×`likelihood`（1〜5）の**正規化値**（後述の換算法で5段階へ丸め）。
   * `risk_detail` に失敗時のビジネス影響・発生シナリオを簡潔に記述。
6. **重複統合と欠落チェック**：
   * 類似観点は統合し、**冗長性を10%以下**に抑える。
   * 主要フローの**正常→準正常→異常**の三層で空白がないかチェック。
7. **優先度づけ**：
   * `risk_score` と**到達頻度**・**回復困難性**を加味して `priority`（High/Med/Low）を算出。
8. **検収ルール（Phase 1）**：
   * すべての主機能に対し、`normal` 少なくとも1件、`quasi` 1件以上、`abnormal` 1件以上を確保。
   * 各観点に**出典参照**があること。

**Phase 1の提示フォーマット（テンプレ）**

```markdown
# スコープ要約
対象: 〇〇。主要アクター: △△。非対象: ××。

## アクターと主機能
- アクター: 一般ユーザー / 管理者 …
- 主機能: 新規登録, 認証, 受注, 承認 …

## テスト観点一覧
| vp_id | title | feature | actor | preconditions | expected_core | test_class | risk(1-5) | priority | source |
|------|-------|---------|-------|---------------|---------------|------------|-----------|----------|--------|
| VP-001 | 必須入力の検証 | 会員登録 | 一般ユーザー | フォーム表示済 | 必須未入力は警告表示 | normal | 3 | Med | DOC-1 §3.2 p.12 |
| VP-002 | 不正フォーマットの拒否 | 会員登録 | 一般ユーザー | ー | メール形式誤りを検知 | quasi | 3 | Med | DOC-1 §3.2 p.13 |
| VP-003 | 想定外メールドメイン | 会員登録 | 一般ユーザー | ー | エラー画面/ログ記録 | abnormal | 4 | High | DOC-1 §3.4 p.18 |
```

### Phase 2：業務シナリオ設計

1. **シナリオ設計方針**：
   * 単機能の断片検証を避け、**業務の開始条件→主要分岐→終了条件**の物語線で構成。
   * **複数観点**（できれば normal/quasi/abnormal を横断）を1本の流れに編成。
2. **シナリオ骨子**：
   * `given`（前提）/`when`（行為）/`then`（期待結果）を中核に、**データ前提と役割**も明示。
3. **リスク再評価**：
   * 取り込んだ観点の `risk_score` を**合成**（最大値ベース＋頻度補正）してシナリオの `risk_score` を決定。
4. **網羅と最小集合**：
   * **高リスク観点は必ずカバー**。中低リスクは**代表シナリオ**へ折り込み、ケース爆発を抑制。
5. **検収ルール（Phase 2）**：
   * 各シナリオに**目的**・**終了条件**・**観点トレーサビリティ**があること。
   * ユーザーストーリーと整合し、**実行可能**かつ**前提データの再現性**があること。

**Phase 2の提示フォーマット（テンプレ）**

```markdown
# 業務シナリオ一覧

## SC-001: 会員登録〜メール認証〜初回ログイン
- objective: 新規ユーザーが登録し、認証済みで初回ログインできる
- actor: 一般ユーザー
- given:
  - メール受信可能なテストアカウントがある
- when:
  1. 会員登録フォームに有効値を入力して送信
  2. 認証メール内リンクを開く
  3. ログイン画面で認証済みアカウントでログイン
- then:
  - ダッシュボードが表示され、初回導線が提示される
- steps:
  1) 入力: 必須/任意項目を仕様通りに入力 → 送信  
     期待: 成功トースト表示、認証メール送信ログ
  2) 動作: 認証リンクを開く  
     期待: 認証完了メッセージ
  3) 入力: ログイン  
     期待: ダッシュボード表示
- covers_vp: VP-001, VP-002, VP-007
- risk: 3
- end_condition: ダッシュボード表示、監査ログ出力
- observability: メッセージID REG-200/201、ログキー `auth.email.sent`
```

## 5. リスク評価ルーブリック

* **影響（impact）**：
  1=軽微、2=一部機能影響、3=主要機能影響、4=取引/業務停止、5=コンプラ/金銭損失重大
* **発生可能性（likelihood）**：
  1=稀、2=低頻度、3=中、4=高、5=恒常的に起こりうる
* **スコアの丸め**：`raw = impact * likelihood` を 1–25 で得点化し、
  1–3→1、4–7→2、8–11→3、12–17→4、18–25→5 に丸めて `risk_score` とする。

## 6. 出力品質ルール（共通）

* **出典必須**：`source_refs` に `doc_id` / `section` / `page` 等を保持。
* **用語統一**：アクター名・機能名・画面名は**原文準拠**。
* **非公開思考の扱い**：LLMは内部で段階的に思考するが、**推論過程は出力しない**。必要最小限の根拠のみ記載。
* **再現性**：ID命名規則（§8）と提示フォーマットを遵守。
* **重複排除**：観点・シナリオのタイトルは**ユニーク**。
* **可観測性**：各シナリオは**検証手段**（UI要素・ログ・メッセージ等）を明示。

## 7. ID命名規則

* `VP-001` 形式で連番（観点）。
* `SC-001` 形式で連番（シナリオ）。
* 同一プロジェクト内で重複しないこと。派生は `-A` `-B` を付ける。

## 8. 実行手順（LLMが従う指示）

1. **ソース文書の登録確認**：参照可能な形で与えられているかを確認。未提供なら不足を列挙。
2. **Phase 1 実施**：`test_viewpoint_identify_guide.md` に従って観点を生成。
   * 出力：JSON＋Markdown。品質チェック（§4, §6）合格まで自己修正。
3. **Phase 2 実施**：確定した観点を入力に、`test_scenario_design_guide.md` に従ってシナリオを生成。
   * 出力：JSON＋Markdown。品質チェック（§4, §6）合格まで自己修正。
4. **要約**：最終的に、優先実行すべき**Top N（既定=20）**シナリオをリストし、根拠（合成リスク・カバレッジ）を簡潔に示す。

## 9. 優先度算出の既定式

* `priority = High` if `risk_score ≥ 4` or 監査/決済/法令関連を含む
* `priority = Med` if `risk_score = 3`
* `priority = Low` if `risk_score ≤ 2`
* 管理者はプロジェクト都合で上書き可（理由を記録）。

## 10. トレーサビリティ運用

* 高リスク観点（risk ≥ 4）は**少なくとも1本**のシナリオがカバー。
* シナリオは `covers_vp` を列挙し、**被覆漏れ**を見える化。
* 被覆漏れがある場合は「不足シナリオ要求」を末尾に自動生成して記載。

## 11. 非機能の取り扱い（抜粋）

* 性能：代表データ量を`given`に明記（例：1万件CSV、10MB画像）。
* セキュリティ/権限：ロール横断の準正常・異常を最低1本ずつ。
* 多言語/通貨/タイムゾーン：`quasi`と`abnormal`を最低1本ずつ確保。

## 12. 出力の最終要約（Top N）

最後に「**優先実行シナリオ Top N（既定=20）**」を以下の書式で列挙する。

```markdown
# 優先実行シナリオ Top 20（例）
| rank | sc_id | title | risk | covers_vp(抜粋) | 根拠 |
|-----:|------|-------|------|-----------------|------|
| 1 | SC-001 | 会員登録〜初回ログイン | 4 | VP-001,002,007 | 高頻度×回復困難 |
| 2 | SC-004 | パスワード再設定フロー | 4 | VP-015,016 | 監査要件影響 |
...
```

## 13. 禁則事項

* 思考プロセス（逐語的な推論手順）を外部出力しない。根拠は**要点のみ**。
* シナリオを**機能単位のバラバラ**に分解しすぎない。
* 出典のない観点・シナリオを作らない（合意済みの仮説を除く）。

## 14. 実行パラメータ（上書き可）

* `TOP_N_SCENARIOS`（既定=20）
* `RISK_THRESHOLD_HIGH`（既定=4）
