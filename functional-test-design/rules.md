# rules.md — 機能一覧の抽出と機能テスト設計の運用手順

## 目的と適用範囲

* 本手順は、**利用手順書／仕様書／要件定義書**等のドキュメントを入力として、アプリケーションの**全機能**を抽出し、**網羅的な機能テスト**を設計・出力するためのもの。
* 出力は以下の2ファイルとする。

  * `result/function_list.md`：機能一覧（ツリー構造・重要度付き）
  * `result/functional_test_cases.md`：機能テストケース（表形式・ID付与・網羅性重視）

## 入力・前提

* 入力ドキュメントは別途提供される（複数可）。版数や日付が混在する場合は**最新版**を優先し、差分は備考に明記する。
* 対象は**機能（Functional）**。非機能（性能・可用性・セキュリティ等）は原則含めない（ただし機能に密接に結合する**入力検証・権限差異・状態遷移**は機能観点として扱う）。
* 用語揺れは**最も定義が明確な原典**に合わせ統一する。

## 役割

* LLMは本`rules.md`の規約順守を最優先とし、疑義は**仮説→明記**の順で扱う（「不明点/前提」欄に記録）。

---

## 全体フロー

1. **Phase A：機能一覧の抽出（Function Identification）**

   * ドキュメントから機能を抽出し、**粒度レベル**と**カテゴリ**でツリー化。
   * 各機能に**重要度**を付与。
   * 依存関係・前提条件・権限制約を明記。
   * 成果物：`result/function_list.md`

2. **Phase B：機能テスト設計（Functional Test Design）**

   * 抽出した機能一覧を出典として、**網羅的**なテストケースを設計。
   * 各ケースに**一意ID**、**カテゴリ**、**機能ID**、**テスト観点**、**データバリエーション**を付与。
   * 成果物：`result/functional_test_cases.md`

> Phase B は **Phase A の完了後**にのみ着手可能。Phase A の修正が入った場合は **差分反映**を厳守。

---

## 共通ポリシー

### 粒度・構造

* 機能は以下の**3層粒度**を基本とする（必要に応じて±1層拡張可）

  * **L1 機能群**：ユーザが意味的にまとまりとして認識する領域（例：ユーザ管理）
  * **L2 機能**：ユーザが達成する目的単位（例：ユーザ登録、ユーザ検索）
  * **L3 サブ機能/操作**：具体的な操作・分岐（例：メール重複時の登録、CSV一括登録）
* **停止条件（十分性）**：

  * 主要ユースケースがL2以上で網羅され、L3で**入力制約・分岐・権限差**が識別できること。
  * CRUDやステート遷移、バリデーション境界が特定できること。

### カテゴリ（ツリー）

* ドメイン別（例：会計/在庫/顧客）やユースケース別（例：登録/検索/更新/削除）など、**一貫した軸**でツリー化。
* ノード表記は `カテゴリ/サブカテゴリ/.../機能` のパス形式で記録。

### 重要度（Business Criticality）

* テスト優先度の基準として、機能ごとに以下の**重要度**を付与：

  * **A（必須/致命）**：法令・収益・基幹処理・外部連携の中核
  * **B（高）**：主要業務で頻出、失敗時の業務影響が大きい
  * **C（中）**：一般的業務、迂回可能
  * **D（低）**：周辺・希少操作、影響軽微
* 根拠（規制要件、SLA、処理頻度、金額影響など）を**簡潔にメモ**する。

### 表記・識別子

* **機能ID**：`FUNC-<カテゴリ略号>-<連番>`（例：`FUNC-USER-001`）
* **テストID**：`FT-<カテゴリ略号>-<連番>`（例：`FT-USER-001`）
* 連番は**カテゴリごと**に採番。機能とテストの**トレーサビリティ**を維持。

### 参照・根拠

* 各行に**出典（文書名/章/ページや見出し）**を記載。矛盾や未定義は「不明点」に記録。

### 網羅性の作法（必須）

* CRUD表（実体ごと）
* 入力検証：**同値分割**・**境界値**・**必須/形式/長さ/列挙**・**依存項目**
* 分岐網羅：**決定表**/条件組合せ（優先度に応じ縮約）
* 状態遷移：有効/無効状態・遷移禁止・再遷移
* 役割/権限：**ロール差**・アクセスコントロール
* エラー/例外：ユーザ可視メッセージ・リトライ・ロールバック
* 外部連携：API/ジョブ/メッセージキューの入出力と失敗時挙動

---

## Phase A：機能一覧の抽出 — 出力仕様と手順

### 出力：`result/function_list.md`

* 形式：Markdown。**表＋ツリー**の二部構成（先頭にサマリツリー、その後に表）。

* 最低限の列：

  1. **Function ID**
  2. **名称**
  3. **カテゴリパス**（`/`区切り）
  4. **概要**（1–3行）
  5. **重要度**（A/B/C/D）
  6. **前提/依存**（ログイン要否、権限、前置処理など）
  7. **主要入力/出力**（代表項目のみ）
  8. **出典**（文書名・章・見出し等）
  9. **不明点/仮定**（あれば）

* 例（行イメージ・簡略）

  | Function ID   | 名称    | カテゴリパス    | 概要       | 重要度 | 前提/依存 | 主要入力/出力             | 出典      | 不明点/仮定    |
  | ------------- | ----- | --------- | -------- | --- | ----- | ------------------- | ------- | --------- |
  | FUNC-USER-001 | ユーザ登録 | 管理/ユーザ/登録 | 新規ユーザを作成 | A   | 管理者権限 | 入:メール, 役割 / 出:ユーザID | 要件 §3.1 | 役割の初期値未記載 |

### 手順

1. **下準備**：全ドキュメントを走査し、目次・見出し・UI操作手順・API一覧から候補を抽出。
2. **正規化**：重複・別名を統合、語彙統一。
3. **ツリー化**：カテゴリ軸を選定してパス化。
4. **重要度付与**：影響・頻度・規制・外部連携の有無で評価。根拠メモを添える。
5. **前提/依存の明記**：ログイン/権限/前処理/外部接続。
6. **品質ゲート A**：

   * L2網羅（主要機能）とL3の代表分岐が列挙されているか
   * すべてに重要度・出典があるか
   * 不明点が別途記録されているか
     合格後、`result/function_list.md`として保存。

---

## Phase B：機能テスト設計 — 出力仕様と手順

### 出力：`result/functional_test_cases.md`

* 形式：Markdownの**表**。カテゴリ単位でセクションを分ける。

* 最低限の列：

  1. **Test ID**（`FT-<カテゴリ>-<連番>`）
  2. **カテゴリ**（機能一覧のカテゴリパス）
  3. **Function ID**（`FUNC-...`）
  4. **タイトル**（目的が一読で分かる文）
  5. **前提条件**（ログイン/権限/初期データ/システム状態）
  6. **手順**（手順番号で簡潔に）
  7. **期待結果**（画面/UI変化/DB/メッセージ/外部呼出）
  8. **重要度**（機能一覧に対応：A/B/C/D）
  9. **テスト観点**（例：境界値、同値分割、必須、形式、権限差、状態遷移、決定表等）
  10. **データバリエーション**（必要に応じ表内で箇条書き）
  11. **出典**（機能一覧の参照＋原典）
  12. **備考/不明点**（あれば）

* 例（行イメージ・簡略）

  | Test ID     | カテゴリ      | Function ID   | タイトル         | 前提条件     | 手順      | 期待結果              | 重要度 | テスト観点  | データバリエーション | 出典                     | 備考 |
  | ----------- | --------- | ------------- | ------------ | -------- | ------- | ----------------- | --- | ------ | ---------- | ---------------------- | -- |
  | FT-USER-001 | 管理/ユーザ/登録 | FUNC-USER-001 | 正常登録（必須最小項目） | 管理者でログイン | 1)… 2)… | ユーザID採番・一覧反映・通知送信 | A   | 同値/正常系 | 役割=一般      | FUNC-USER-001, 要件 §3.1 | —  |

### 設計ルール

* **網羅性最優先**：

  * 正常／異常（必須欠落、形式不正、境界超過、重複、依存不整合）
  * 役割差（権限別）
  * ステート差（有効/無効・処理中・ロック等）
  * 外部失敗（APIタイムアウト、検証NG）
* **縮約の原則**：重要度A/Bは**詳細網羅**、C/Dは**代表値**に縮約。ただし**決定的な境界**は必ず1件以上含める。
* **一貫性**：タイトルは「何を検証するか→どうなるか」を短文で。手順は**可観測**な操作のみ。期待結果は**UI/データ/メッセージ**を分けて具体化。
* **トレーサビリティ**：各テストは**Function ID**に必ず紐付ける。
* **重複排除**：同観点・同前提・同期待なら統合。差分は**データバリエーション**欄で表現。
* **不明点の扱い**：仮説で設計した箇所は**備考**に明記し、後続レビューで確定させる。

### 品質ゲート B

* すべての **A/B 重要度の機能**に対し、正常系＋主要な異常系が存在する。
* 期待結果が**観測可能**で、合否判定が**二値**で下せる。
* 各テストに**Function ID**と**出典**が付与されている。
* **観点の偏り**（正常のみ、UIのみ等）がない。
* IDの重複なし、カテゴリ整合。

---

## 変更管理と差分反映

* 機能一覧の更新が発生した場合、以下を**同一コミット**で実施：

  1. `function_list.md`更新 → 2) 影響する`functional_test_cases.md`の**追加/修正/廃止** → 3) 差分サマリ追記。
* **破壊的変更**（仕様逆転・削除）は、テストの**廃止理由**を備考に残す。

---

## 出力形式のガイドライン

* すべてMarkdown。見出しは `## カテゴリ名` 単位で分節。長表はカテゴリごとに分割。
* 用語は一貫・簡潔・冗長禁止。数値・桁数・フォーマットは**明示**（例：YYYY-MM-DD, 半角英数）。
* メッセージ文言は**実際の表示例**があれば引用（可能な限り短く）。

---

## 既知の落とし穴（事前チェック）

* **機能≠画面**：同一画面でも機能は複数あり得る。
* **ユースケースの抜け**：バッチ/ジョブ、インポート/エクスポート、エラー再試行。
* **権限差の見逃し**：管理者・一般・閲覧専用など。
* **派生ルールの陰在**：メール一意、番号体系、業務日付と会計日付の差、タイムゾーン。
* **外部依存**：APIスキーマ・認証・レート制限・リトライ・整合性。

---

## 完了条件（Definition of Done）

* `result/function_list.md` と `result/functional_test_cases.md` の両方が存在し、**品質ゲート A/B**を満たす。
* すべてのA/B機能が**少なくとも1件の正常**と**主要異常**でカバー。
* 重要度・出典・トレーサビリティが欠落していない。
* 不明点が**明記**され、次アクションが分かる。
