# 判断理由・ギャップ分析ガイド

## 1. このガイドの目的

本ガイドは、以下の 2 つを一貫したルールで記述するための指針を与える。

1. **判断理由**  
   - 各品質基準（クライテリア）をどのような根拠で導いたのかを、  
     ドキュメントや前提条件に紐づけて説明する。

2. **問題点の指摘（ギャップ分析）**  
   - クライテリアを妥当な精度で定めるために、  
     必要な情報や観点が **不足している / 曖昧である / 矛盾している** 箇所を明示する。

このガイドのゴールは、

- 「なぜその基準になったのか？」を説明できる状態にすること。
- 「何が分かっていて、何が分かっていないか？」を切り分けること。

であり、**LLM が勝手に不足情報を埋めてしまうことを防ぐ**ことも重要な目的とする。

---

## 2. 用語の定義

### 2.1 判断理由（reasoning）

ある品質基準について、

- どの情報を根拠に
- どのように解釈して
- どの品質特性として扱い
- どのようなリスク・利用シナリオを想定したか

を言語化したもの。

**ポイント：**

- 「どのドキュメントのどこを読み取ったか」が分かること。
- 「その読み取りから、なぜその方向性のクライテリアが必要になるのか」が分かること。

### 2.2 問題点の指摘（ギャップ）

品質基準を策定するうえで、次のような状態になっている箇所を「問題点」と呼ぶ。

- 必要な情報が **書かれていない**
- 記述が **抽象的 / 曖昧** すぎて基準を定められない
- 文書同士で **矛盾** している
- 利用シナリオや前提条件が **不明** であり、適切な水準を決められない

これらを列挙し、それに対する「次のアクション」は `action_planning_guide.md` 側で扱う。

---

## 3. 前提・インプット

判断理由と問題点の指摘を行うとき、LLM は少なくとも次を参照する。

- `rules.md`
  - 判断理由・問題点・次のアクションをどのように出力するかの全体ルール
- `nfr_extraction_guide.md`
  - 非機能候補の一覧（NFR-xxx とその元文）
- `quality_model_overview_guide.md`
  - 7特性へのマッピングの考え方
- `quality_criteria_design_guide.md`
  - 各クライテリアの項目（criterion_id, description, verification_method 等）
- 対象システムのドキュメント一式
  - 要件定義書 / 利用手順書 / 仕様書 / 運用設計書 / 構成図 等

---

## 4. 判断理由の組み立て方（プロセス）

LLM は、1つのクライテリアごとに、次の流れで判断理由を組み立てる。

1. **関連する情報の洗い出し**
   - `related_nfr_candidates` に紐づく NFR を確認する。
   - それ以外にも、同じ章や近い箇所に関連する説明がないか確認する。

2. **前提条件・利用シナリオの整理**
   - 文書中に書かれている、または暗黙に想定されている利用シナリオを言語化する。
   - 例：月次締め処理、平日日中帯の通常業務、夜間バッチ処理 など。

3. **品質特性の観点を明示する**
   - 主となる品質特性（quality_characteristic）を改めて意識し、  
     「このクライテリアは、主に何を守るためのものか」を言語化する。

4. **根拠 → 解釈 → クライテリア という流れで説明する**
   - 「根拠となる文書・記述」
   - 「それをどう解釈したか」
   - 「その結果として、このクライテリアが必要になる理由」
   の 3 段階で説明する。

5. **不明点・仮定を分離する**
   - 判断に利用した仮定（例：ユーザー数が多い前提）は、  
     どこまでが文書に書かれており、どこからが推論かを区別して述べる。
   - 推論が多い場合は、そのままギャップとして「問題点の指摘側」にも反映する。

---

## 5. 判断理由の構造（フォーマット）

判断理由は、以下のような構造で記述することを推奨する。

```markdown
#### <criterion_id> <criterion_title>

- 主な根拠ドキュメント
  - <文書名> <章・節・見出し>：<要約 or 原文の一部>
  - <文書名> <章・節・見出し>：<要約 or 原文の一部>

- 想定している利用シナリオ・前提
  - <具体的な業務場面や運用条件>
  - （例：月次締め処理で大量データを夜間にインポートし、業務開始前に完了している必要がある）

- 品質特性の観点
  - 主特性：<性能効率性 / 信頼性 / セキュリティ など>
  - 関連特性：<任意>

- 上記を踏まえた判断のポイント
  - <なぜそのクライテリアが必要と判断したか>
  - <どのようなリスクを防ぐための基準か>
  - <検討したがクライテリアに含めなかった観点があれば、その理由>
````

### 5.1 注意点

* 引用する文書内容は、**要約でよい**。
  （必要以上に原文を長く貼り付けない）
* 「〜と思われる」「〜と推測される」といった表現を使う場合、
  それがどの程度文書に裏付けられているかを説明する。

---

## 6. 問題点の指摘（ギャップ）の洗い出し方

### 6.1 どこからギャップが生まれるか

次のような場合に、「問題点」として列挙する。

1. **情報の不足**

   * データ量やユーザー数が不明で、性能・容量系の基準を決められない。
   * 障害時の運用ポリシー（RTO/RPO）が未定義。

2. **曖昧な表現**

   * 「使いやすいシステムとする」「業務上問題ない範囲」とだけ書かれていて、
     何が「使いやすい」かが明確ではない。

3. **矛盾する記述**

   * 要件定義書と仕様書で、可用性やセキュリティレベルの前提が違う。
   * 構成図と説明テキストが一致していない。

4. **前提条件の不明確さ**

   * 「24時間 365日運用」と書いてあるが、メンテナンス時間帯の扱いが不明。
   * システムの利用者層（一般ユーザーか社内限定か）が分からない。

### 6.2 問題点のレベル感

すべてを同じ重みで列挙するのではなく、
可能であれば以下のような粒度で整理してもよい。

* クリティカル（品質基準の策定自体が成立しないレベル）
* 中程度（基準自体は決められるが、妥当性の評価が難しいレベル）
* 軽微（追加で決められると望ましいが、現時点でも運用でカバー可能）

---

## 7. 問題点の書き方（フォーマット）

問題点は、`rules.md` の「問題点の指摘」「次のアクション」に対応する形で、
以下のような形式を基本とする。

```markdown
### 問題点の指摘（<品質特性名> 関連）

1. <問題点の要約>  
   - 関連クライテリア：<criterion_id>（あれば）
   - 根拠ドキュメント：<文書名> <章・節> / <未記載 など>
   - 詳細：
     - <何が不足/曖昧/矛盾しているのか>
     - <どのような判断ができない状態になっているか>

2. <問題点の要約>  
   - ...
```

### 7.1 例：性能効率性に関する問題点

```markdown
### 問題点の指摘（性能効率性 関連）

1. 想定データ量・ユーザー数が要件定義書に明記されていない。  
   - 関連クライテリア：PE-001（インポート処理の完了時間）
   - 根拠ドキュメント：要件定義書 3.2 インポート機能
   - 詳細：
     - 「大量データをインポートする」と記載されているが、具体的なレコード件数やファイルサイズが不明である。
     - そのため、目標とする処理時間の妥当性（例：60分以内）が判断しづらい状態である。
```

---

## 8. Few-Shot：判断理由＋問題点のセット例

### 8.1 前提（クライテリア）

```markdown
| criterion_id | quality_characteristic | related_nfr_candidates | criterion_title                       |
|-------------|------------------------|------------------------|---------------------------------------|
| PE-001      | 性能効率性             | NFR-101                | 月次インポート処理の完了時間         |
```

### 8.2 判断理由の例

```markdown
#### PE-001 月次インポート処理の完了時間

- 主な根拠ドキュメント
  - 要件定義書 3.2 インポート機能：
    - 「月次締め処理のデータインポートは、業務開始前の 2時間以内に完了すること。」という記載がある。
  - 運用設計書 2.1 運用時間帯：
    - 「通常業務時間は平日 9:00〜18:00、月次締め処理は前日 23:00〜翌日 8:00 の間に実施する。」という記載がある。

- 想定している利用シナリオ・前提
  - 月次締め処理において、前日夜〜当日朝にかけて大量データのインポートを実行する。
  - 9:00 の通常業務開始までにインポートが完了していない場合、業務に支障が出る前提で運用される。

- 品質特性の観点
  - 主特性：性能効率性
  - 関連特性：信頼性（処理が完了しない場合の業務影響が大きいため）

- 上記を踏まえた判断のポイント
  - 業務開始時刻までにインポート処理を安定して完了させることが求められているため、
    「月次本番相当データ量を対象として、業務開始前までに処理が完了する」というクライテリアを設定した。
  - 具体的な目標時間（例：60分以内）は、現在のシステム構成や処理方式に基づく暫定値であり、
    実際の運用データ量・インフラ構成に応じて調整されることを前提としている。
```

### 8.3 問題点の指摘の例

```markdown
### 問題点の指摘（性能効率性 関連）

1. 月次インポートの対象データ量・ピーク時の同時実行数が不明である。  
   - 関連クライテリア：PE-001
   - 根拠ドキュメント：
     - 要件定義書 3.2 インポート機能（「大量データ」とのみ記載）
     - 運用設計書 2.1 運用時間帯（業務時間のみ記載）
   - 詳細：
     - 具体的なレコード件数やファイルサイズ、同時に実行されるインポートジョブ数が定義されていない。
     - そのため、「60分以内」という目標時間の妥当性を、業務面・インフラ面の両方から評価しづらい状態である。
     - 今後、業務担当者・インフラ担当者との協議により、想定データ量と実際の負荷条件を明確化する必要がある。
```

---

## 9. LLM が守るべき原則・禁止事項

1. **不足情報を創作しない**

   * ドキュメントに書かれていない値や条件を、「事実のように」書いてはならない。
   * 推論や一般的な慣例に基づく記述は、「推論である」「一般的な例である」と明示する。

2. **判断理由と問題点を混ぜない**

   * 判断理由では、「ある前提のもとで、なぜこのクライテリアにしたのか」を説明する。
   * その前提自体が危うい場合は、別途「問題点の指摘」に切り出す。

3. **曖昧な表現をそのまま放置しない**

   * 文書側が曖昧な場合、クライテリア側では可能な範囲で具体化を試みてよいが、

     * その際に生じる前提・仮定は判断理由に書く。
     * 曖昧さ自体は問題点として明示する。

4. **人間がレビューしやすい構造を意識する**

   * 根拠 → 解釈 → クライテリア → 問題点
     の流れが追えるように書く。
   * 専門用語だけでなく、業務担当者や PM が読んでも理解できる説明を心がける。

---

以上のガイドに従い、LLM は各品質基準について **判断理由** を整理し、
同時に、品質基準の前提となる情報の不足・曖昧さ・矛盾を **問題点の指摘（ギャップ）** として洗い出すこと。
