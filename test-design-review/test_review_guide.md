# test_review_guide.md — テストケースレビュー用プロンプトガイド

この文書は、`test_viewpoint_identify_guide.md` で抽出した**テスト観点**と、作成済み **テストケース（CSV）** を突き合わせてレビューを行うための、LLM向けプロンプト指示テンプレート。出力は **Markdown 固定**。

## 関連ドキュメント

* **`rules.md`**: 全体のルール、採点基準、スコア算出方法、総合評価ランクを定義
* **`test_viewpoint_identify_guide.md`**: テスト観点抽出の詳細手順（本ガイドの前提となる観点抽出結果を生成）

---

## 1. ゴールと出力定義

* ゴール: 観点カバレッジ、粒度、リスク優先、非機能、再利用性の観点から、テストケースの妥当性を判定し、**次に何を直すか**まで落とし込む。
* ユーザー指定の**重点レビュー観点**を必ず反映（例: 「異常系と再利用性を重視」）。
* 出力: サマリ、スコア（100点×5指標）、問題点の指摘、観点↔ケースの対応表サマリ、**高リスク優先セット**、次アクション（優先度・担当・粒度）— 詳細は §7 テンプレート。

---

## 2. 前提入力

1. 観点抽出結果（Markdown 表）: `ViewpointID, Title, TestCaseType, SourceRef, RiskScore, ...`
2. テストケース CSV: 想定列 `ID, Title, Steps, Expected, Type, Tags, Priority, Risk, Owner, Preconditions, Data` など（不足は推定・提案）。
3. ユーザーの重点レビュー観点（任意）。

---

## 3. レビュー方針

* 基本的なルールと制約は `rules.md` §7 を参照。
* **根拠主義**: 指摘には必ず根拠（観点ID, SourceRef, ケースID, 行番号/列名）を付ける。推測は推測と明示。
* **リスク駆動**: 観点側の `RiskScore` とケース側の `Priority/Risk/Tags` を統合して優先順位を決める。
* **再現性**: 見出しや表構造はテンプレートどおり固定。
* **非ハルシネーション**: ドキュメントにない仕様は改善**提案**として扱う。

---

## 4. 手順（LLMへの指示）

1. **正規化**: CSV 列名/値の表記ゆれを吸収し、`Type` を `正常系/準正常系/異常系/非機能` に正規化。ID 重複/飛び番/空行を検出。
2. **マッピング**: 各ケースを 0..n 個の観点に紐付ける。方法: `Title/Steps/Expected/Tags/Type` を用いて、`ViewpointID` 候補をスコアリング。多対多のまま保持可。
3. **ギャップ分析**:

   * **未カバー観点**（ケースが1件も割り当たらない Viewpoint）
   * **過剰/重複ケース**（同一観点へ類似ケースが多数）
   * **偏り**（正常系 過多、異常系/非機能 不足）
4. **品質評価**（各100点）: `rules.md` §3 の採点基準に従って評価。

   * **網羅性**: 観点カバー率、正常系/準正常系/異常系/非機能 比率の妥当性、業務フローの分岐/例外の反映。
   * **粒度**: 1 ケース = 1 観点（ないし小目的）、Steps の簡潔さ、期待結果の観測可能性（UI/ログ/DB/API）。
   * **有効性**: 高リスク観点に対応するケースが優先配置され、期待結果が失敗原因追跡可能。
   * **再利用性**: データ駆動化、固定文言/順序依存の低さ、前提/後処理の明確さ、抽象度。
   * **非機能の組み込み**: 性能/セキュリティ/ログ/アクセシビリティ/可用性など対象に見合う網羅。
5. **高リスク優先セット**: 観点 RiskScore とケース側の Priority/Risk を合成し、**今すぐ回すべき最小セット**（例: 20〜30件）を抽出。
6. **改善提案**: 統合/分割、期待結果の観測点の明確化、非機能/境界値の追加、データ駆動化、タグ/Type の是正など、**編集手順レベル**で提示。
7. **出力整形**: §7 テンプレートで Markdown を生成。

---

## 5. スコアリング詳細

* スコア算出と総合評価の基準は `rules.md` §3, §4 を参照。
* デフォルト重み: 均等（各20%）。重点観点が指定された場合、その項目の重みを少しだけ上げる（例: 指定30%、他は均等）。
* 総合ランク: `S/A/B/C/D`（`rules.md` §4 の規準に従う）。
* 参考メトリクス（自動計算）:

  * 観点カバー率 = `covered_viewpoints / total_viewpoints`
  * 重複率 = `duplicate_clusters / total_cases`
  * Type 比率 = `正常系, 準正常系, 異常系, 非機能` の構成
  * 観測可能性率 = `Expected が検証可能に書かれたケース数 / total_cases`

---

## 6. 典型的な欠陥パターン（検出ルール）

* **期待結果が曖昧**: 「保存できること」「正しく表示されること」「問題がないこと」等の曖昧語。観測点（UI要素/ログ/DB/API/メトリクス）と、何をもって合否とするかが明確でない。
* **抱き合わせ**: 1ケースで複数観点を同時検証。失敗時に原因特定が困難。
* **正常系偏重**: 異常系/準正常系 が薄い。境界値/エラー遷移/通信断が抜けがち。
* **非機能の分離依存**: 性能・監査・権限試験がケースに織り込まれていない。
* **固定値/文言依存**: 画面文言や順序に過剰依存。データ駆動化が不足。
* **前提不足**: 権限・初期データなどの前提が書かれていない。

---

## 7. 出力テンプレート（Markdown厳守）

```markdown
# テストケース レビュー結果（観点照合）

## サマリ
- 総合評価: <S|A|B|C|D>
- スコア
  - 網羅性: <0-100>
  - 粒度: <0-100>
  - 有効性: <0-100>
  - 再利用性: <0-100>
  - 非機能の組み込み: <0-100>
- 重点観点: <指定があれば>
- 観点: <抽出版/件数/Type構成>
- ケースCSV: <名称/件数>

## 主要所見（根拠つき）
1. <所見1>
   - 根拠: 観点 <VP-xxx>（<SourceRef>） ↔ ケース <TC-xxx>（列 <Steps/Expected/...>）
2. <所見2> ...

## 観点カバレッジ
- 未カバー観点: <VP-IDs>
- 過剰/重複: <ケースIDクラスタ例>
- Type 比率: 正常系 <n> / 準正常系 <n> / 異常系 <n> / 非機能 <n>

## 高リスク優先セット（推奨実行順）
1. <ケースID> — 由来観点: <VP-IDs>（RiskScore: <max/avg>）— 理由: <簡潔に>
2. ...

## 改善提案
- 高: <提案/対象ケースまたは観点/担当/期限/期待効果>
- 中: <...>
- 低: <...>

## 追加すべきテストケースの提案
指摘した欠落や不足に対して、具体的な追加テストケースを提案する。

### 非機能テストケースの提案（非機能が不足している場合）
| テストケースID | タイトル | テストタイプ | 前提条件 | 手順 | 期待結果 | 関連観点ID | 根拠 |
|---|---|---|---|---|---|---|---|
| TC-PROP-001 | <例: ログイン処理の応答時間測定> | 非機能 | <前提> | <ステップ> | <観測可能な結果> | <VP-xxx> | <参照箇所> |

### 異常系テストケースの提案（異常系が不足している場合）
| テストケースID | タイトル | テストタイプ | 前提条件 | 手順 | 期待結果 | 関連観点ID | 根拠 |
|---|---|---|---|---|---|---|---|
| TC-PROP-002 | <例: 通信断時のエラーハンドリング> | 異常系 | <前提> | <ステップ> | <観測可能な結果> | <VP-xxx> | <参照箇所> |

### 準正常系テストケースの提案（準正常系が不足している場合）
| テストケースID | タイトル | テストタイプ | 前提条件 | 手順 | 期待結果 | 関連観点ID | 根拠 |
|---|---|---|---|---|---|---|---|
| TC-PROP-003 | <例: 境界値での入力検証> | 準正常系 | <前提> | <ステップ> | <観測可能な結果> | <VP-xxx> | <参照箇所> |

## 付録
- 観点↔ケース対応表（要約）
| ViewpointID | CaseIDs | Coverage | Notes |
|---|---|---:|---|
| VP-001 | TC-12, TC-45 | 2 | <重複/不足など>
| VP-002 | — | 0 | <未カバーの理由>
```

---

## 8. Few-shot 例（抜粋）

### 8.1 例A: ログイン

**前提**: 観点 `VP-LOGIN-01..04`（正常ログイン、境界、ロック、監査）。CSV には `TC-01: 正常ログイン`, `TC-02: パスワード最短`, `TC-03: 5回連続失敗`, `TC-04: 成功/失敗ログ確認` 等。

**所見例**

* `TC-02` は「形式誤り（@なし）」を欠落。`VP-LOGIN-02` の境界・形式観点を網羅できていない。
* `TC-03` の期待結果が「エラーになること」で曖昧。`UIエラー表示` と `監査ログ（ロックイベント）` の観測点を明記すべき。
* 非機能 `VP-LOGIN-04` に対するケースは `TC-04` のみで、成功/失敗/ロックの3状態の監査網羅が不足。

**高リスク優先セット**

* `TC-03`（ロック）→`TC-02`（境界形式）→`TC-04`（監査3状態補完）

### 8.2 例B: 受注→引当→出荷（シナリオ）

**前提**: 観点 `VP-ORD-01..04`。CSV に `TC-21: 承認後引当`, `TC-22: 在庫不足BO`, `TC-23: 締処理中の出荷ブロック`, `TC-24: 伝票/監査` 等。

**所見例**

* `TC-21` に在庫が**同時更新**された場合の期待結果がない→競合時の再試行/ロールバック観測点が不足。
* `TC-22` はバックオーダ作成後の**通知**と**再引当**の確認が抜けている。
* `TC-24` の伝票番号整合/改ざん防止番号チェックが曖昧。

**高リスク優先セット**

* `TC-23`（締処理ブロック）→`TC-21`（同時更新競合）→`TC-22`（BO通知/再引当）

---

## 9. プロンプト指示テンプレート（LLMに渡すテキスト）

```text
あなたはソフトウェア品質のテストアナリストだ。観点抽出結果とテストケースCSVを突き合わせ、Markdownでレビューを出力する。

【入力】
- 観点: <test_viewpoint_identify_guide.md に従った表全体>
- テストケースCSV: <列定義/抜粋/全件>
- 重点レビュー観点（任意）: <例: 異常系と再利用性>

【手順】
1) CSV を正規化（Type 正規化、ID/列チェック）。
2) タイトル/ステップ/期待結果/タグ/Type から観点へのマッピングを行う。
3) ギャップ分析（未カバー、重複、偏り）。
4) 5指標（網羅性/粒度/有効性/非機能/再利用性）で100点採点し、S〜Dを決定。
5) 観点 RiskScore とケースの Priority/Risk から高リスク優先セットを抽出。
6) 改善提案を具体的編集手順で提示（統合/分割、観測点明確化、データ駆動化、非機能追加 等）。
7) 指摘した欠落や不足に対して、具体的な追加テストケースを提案する（`rules.md` §7 の「追加テストケース提案の義務」に従う）。
8) §7 のMarkdownテンプレートで厳密に出力。

【制約】
- 指摘は根拠付き（観点ID/SourceRef、ケースID/列名）で。推測は提案として明示。
- 用語は入力の用語集に合わせて統一。
- 機微情報はマスク。
```

---

## 10. 自己チェックリスト

* [ ] 重点観点を採点重みに反映した。
* [ ] 未カバー観点が列挙され、理由/対応方針がある。
* [ ] 重複クラスタを提示し、統合/分割の指示が具体的。
* [ ] 非機能の織り込み不足が明確化されている。
* [ ] 高リスク優先セットが現実的な件数/順序で提示されている。
* [ ] すべての指摘に根拠（観点ID/SourceRef、ケースID/列名）が付与されている。
* [ ] 指摘した欠落や不足に対して、具体的な追加テストケースが提案されている。

---

## 11. ノート

* 本ガイドは `rules.md` に準拠。スコア基準/ランク閾値は `rules.md` §4 で定義され、チーム合意でチューニング可。
* 観点リストの版とCSVの版が異なる場合、レビューの前に整合性差分を記録すること。
* 観点抽出は `test_viewpoint_identify_guide.md` に従って実施する。
