# rules.md — LLMによる業務シナリオテスト設計の運用ルール

## 1. 目的と適用範囲

* **目的**：与えられた利用手順書／仕様書／要件定義書（以下「ソース文書」）から、LLMが再現性高く**テスト観点**を抽出し、それらを網羅しつつ実務の流れを意識した**業務シナリオ**へ設計するための運用ルールを定める。
* **適用範囲**：Web/Windows/モバイル等のエンドユーザー操作型アプリケーションを対象。個別ドメインの特殊論点は後述の「ドメイン付帯ルール」で拡張する。

## 2. 用語

* **テスト観点**：ソース文書から抽出した、確認すべき性質・条件・動作。

  * 分類（`test_class`）：

    * `normal`（正常）／`quasi`（準正常：想定内の誤り・回復）／`abnormal`（異常：想定外）
  * リスク：影響×発生可能性で評価（1〜5）。詳細説明を付与。
* **業務シナリオ**：複数の観点を**ユーザーストーリー**や**業務フロー**に沿って束ねた、終端条件までの一連の検証ストーリー。単機能チェックの羅列は禁止。

## 3. 入力と成果物

### 入力（LLMへ与えるもの）

* ソース文書（必須）：利用手順書／仕様書／要件定義書（章・節・ページの参照可能な識別子を付与）
* 制約・前提（任意）：対象環境、対象ロール、非対象範囲、既知の制約
* 非機能の着目点（任意）：性能・セキュリティ・アクセシビリティ等のヒント

### 成果物（LLMが出力するもの）

1. **観点リスト**（Phase 1の最終アウトプット）
2. **業務シナリオリスト**（Phase 2の最終アウトプット）
   両方とも**機械可読なJSON**と**人が読むMarkdown**の二形式で出力する。
   ※JSONの最小スキーマは本書内に定義（§7）。

## 4. 実行フェーズ

### Phase 1：テスト観点の抽出

**概要**：ソース文書からテスト観点を抽出し、分類・リスク評価・優先度付けを行う。

**主要ステップ**：
1. 範囲の確定（対象スコープ・ロール・非対象の要約）
2. アクターと主機能の特定
3. 観点の抽出（出典必須）
4. 分類（normal/quasi/abnormal）と構造化
5. リスク評価（§5参照）
6. 重複統合と欠落チェック
7. 優先度づけ（§10参照）

**検収ルール**：
* すべての主機能に対し、`normal` 少なくとも1件、`quasi` 1件以上、`abnormal` 1件以上を確保。
* 各観点に**出典参照**があること。

**詳細な手順とプロンプトテンプレート**：`test_viewpoint_identify_guide.md` を参照。

### Phase 2：業務シナリオ設計

**概要**：抽出済みのテスト観点を業務フローに沿って束ね、実行可能な業務シナリオを設計する。

**主要ステップ**：
1. シナリオ設計方針の決定（業務フローに沿った物語線の構成）
2. シナリオ骨子の作成（Given/When/Then）
3. リスク再評価（観点のリスクスコアを合成）
4. 網羅と最小集合の最適化

**検収ルール**：
* 各シナリオに**目的**・**終了条件**・**観点トレーサビリティ**があること。
* ユーザーストーリーと整合し、**実行可能**かつ**前提データの再現性**があること。

**詳細な手順とプロンプトテンプレート**：`test_scenario_design_guide.md` を参照。

## 5. リスク評価ルーブリック

* **影響（impact）**：
  1=軽微、2=一部機能影響、3=主要機能影響、4=取引/業務停止、5=コンプラ/金銭損失重大
* **発生可能性（likelihood）**：
  1=稀、2=低頻度、3=中、4=高、5=恒常的に起こりうる
* **スコアの丸め**：`raw = impact * likelihood` を 1–25 で得点化し、
  1–3→1、4–7→2、8–11→3、12–17→4、18–25→5 に丸めて `risk_score` とする。

## 6. 出力品質ルール（共通）

* **出典必須**：`source_refs` に `doc_id` / `section` / `page` 等を保持。
* **用語統一**：アクター名・機能名・画面名は**原文準拠**。
* **非公開思考の扱い**：LLMは内部で段階的に思考するが、**推論過程は出力しない**。必要最小限の根拠のみ記載。
* **再現性**：ID命名規則（§8）とJSONスキーマ（§7）を遵守。
* **重複排除**：観点・シナリオのタイトルは**ユニーク**。
* **可観測性**：各シナリオは**検証手段**（UI要素・ログ・メッセージ等）を明示。

## 7. 最小JSONスキーマ

```json
{
  "viewpoints": [
    {
      "vp_id": "VP-XXX",
      "title": "短い要約タイトル",
      "summary": "観点の説明（1〜3文）",
      "feature": "対象機能/画面/API名",
      "actor": ["一般ユーザー"],
      "preconditions": ["ログイン済み"],
      "expected_core": "期待される性質/結果の要点",
      "test_class": "normal|quasi|abnormal",
      "risk_score": 1,
      "risk_detail": "失敗時の影響や起こり方",
      "priority": "High|Med|Low",
      "source_refs": [{"doc_id": "DOC-1", "section": "3.2", "page": 12}]
    }
  ],
  "scenarios": [
    {
      "sc_id": "SC-XXX",
      "title": "業務の流れを示すタイトル",
      "objective": "シナリオの目的",
      "actor": "一般ユーザー",
      "given": ["前提データAがある"],
      "when": ["操作Xを行う"],
      "then": ["結果Yが表示される"],
      "steps": [
        {"order": 1, "action": "UI操作/入力", "expected": "画面応答/DB更新"},
        {"order": 2, "action": "…", "expected": "…"}
      ],
      "covers_vp": ["VP-001", "VP-007"],
      "risk_score": 1,
      "end_condition": "正常終了/エラー表示/ロールバック完了など",
      "observability": ["画面メッセージID", "ログ出力キー"],
      "source_refs": [{"doc_id": "DOC-1", "section": "4.1"}]
    }
  ]
}
```

## 8. ID命名規則

* `VP-001` 形式で連番（観点）。
* `SC-001` 形式で連番（シナリオ）。
* 同一プロジェクト内で重複しないこと。派生は `-A` `-B` を付ける。

## 9. 実行手順（LLMが従う指示）

1. **ソース文書の登録確認**：参照可能な形で与えられているかを確認。未提供なら不足を列挙。
2. **Phase 1 実施**：`test_viewpoint_identify_guide.md` に従って観点を生成。

   * 出力：JSON＋Markdown。品質チェック（§4の検収ルール、§6）合格まで自己修正。
3. **Phase 2 実施**：確定した観点を入力に、`test_scenario_design_guide.md` に従ってシナリオを生成。

   * 出力：JSON＋Markdown。品質チェック（§4の検収ルール、§6）合格まで自己修正。
4. **要約**：最終的に、優先実行すべき**Top N（既定=20）**シナリオをリストし、根拠（合成リスク・カバレッジ）を簡潔に示す。

**注意**：各フェーズの詳細なプロンプトテンプレート、Few-shot例、実行例は各ガイドファイルを参照すること。

## 10. 優先度算出の既定式

* `priority = High` if `risk_score ≥ 4` or 監査/決済/法令関連を含む
* `priority = Med` if `risk_score = 3`
* `priority = Low` if `risk_score ≤ 2`
* 管理者はプロジェクト都合で上書き可（理由を記録）。

## 11. トレーサビリティ

* 観点→シナリオの**被覆関係**を `covers_vp` で保持。
* シナリオがカバーしない高リスク観点は**別シナリオを要求**。
* すべての `risk_score ≥ 4` 観点には少なくとも1本のシナリオが対応。

## 12. 非機能の取り扱い

* 非機能要求は**観点として抽出**し、可能なら**業務シナリオに組み込む**（例：大量入力、タイムアウト、権限境界）。
* 計測が必要なものは**別途テストタイプ**として外だし可。ただし観点は本リストに残す。

## 13. ドメイン付帯ルール（任意）

* 例：会計・決済・個人情報では法令/監査要件をハイリスク寄与として重み付け。
* 例：多言語・通貨・タイムゾーンは**準正常**に最低1本、**異常**に1本を確保。

## 14. 出力フォーマット（Markdown側の最小例）

```markdown
# テスト観点一覧（抜粋）
| vp_id | title | feature | test_class | risk | priority | source |
|------|-------|---------|------------|------|----------|--------|
| VP-001 | 新規登録の必須入力検証 | 会員登録画面 | normal | 3 | Med | DOC-1 §3.2 p.12 |

# 業務シナリオ一覧（抜粋）
## SC-001: 会員登録〜初回ログインまで
- objective: 新規ユーザーが正常に登録し、初回ログインできること
- actor: 一般ユーザー  
- given: 事前にメールが受信可能  
- when: 登録→メール認証→ログイン  
- then: ダッシュボード表示  
- covers_vp: VP-001, VP-007  
- risk_score: 3  
- end_condition: ダッシュボード表示
```

## 15. 禁則事項

* 思考プロセス（逐語的な推論手順）を外部出力しない。根拠は**要点のみ**。
* シナリオを**機能単位のバラバラ**に分解しすぎない。
* 出典のない観点・シナリオを作らない（合意済みの仮説を除く）。

## 16. 実行パラメータ（上書き可能）

* `TOP_N_SCENARIOS`（既定=20）
* `RISK_THRESHOLD_HIGH`（既定=4）
* `INCLUDE_NON_FUNCTIONAL`（既定=true）
* `LANG`（既定=ja-JP）

---

**関連ガイド**：
* Phase 1の詳細：`test_viewpoint_identify_guide.md`（プロンプトテンプレート、Few-shot例、実行例）
* Phase 2の詳細：`test_scenario_design_guide.md`（プロンプトテンプレート、Few-shot例、実行例）
