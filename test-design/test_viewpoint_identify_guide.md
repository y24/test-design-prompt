# LLMによるテスト観点抽出プロンプト・テンプレート

## 0. ねらい

* ソース文書から、**正常／準正常／異常**を横断する**テスト観点**を抽出する。
* 各観点に**出典**・**リスクスコア**・**優先度**・**前提**・**期待の要点**を必ず付ける。
* 出力は **JSON**（スキーマは `rules.md` の規約に従う／本ガイドでは記述省略）と **Markdown** の二形式。

---

## 1. 事前準備（入力の貼り方）

* 文書ごとに `doc_id` を付け、章節・ページ参照ができる形で与える。長文は分割可。
* 任意でプロジェクトパラメータ（対象ロール、非対象範囲、非機能の着目点など）を付与。

```markdown
### Inputs
- docs:
  - { doc_id: "DOC-OPS-001", title: "運用手順 v1.4", pages: "1-38", link: "share://ops_v1_4" }
  - { doc_id: "DOC-SRS-002", title: "要件定義書", sections: "2,3,5" }
- scope:
  actors: ["一般ユーザー","管理者"]
  in_scope_features: ["会員登録","ログイン","注文","取消"]
  out_of_scope: ["外部決済ゲートウェイ連携"]
- non_functional_hints: ["入力制限","メッセージ整合","タイムアウト耐性"]
```

---

## 2. プロンプト雛形（最小セット）

> 役割：**System**／**User** の2段で投げる。先に `rules.md` を読み込ませておく。

### 2.1 System Prompt（固定）

```
あなたはソフトウェア品質保証のアナリスト。与えられたソース文書から、テスト観点を抽出する。
必ず以下を守る：
- 出力は JSON と Markdown の二形式（JSONのキー・構造は rules.md に準拠）。
- 各観点に出典（doc_id/section/page）を付与。
- normal / quasi / abnormal を主機能ごと最低1件ずつ確保。
- リスクは impact×likelihood を5段階に丸めた risk_score。risk_detail を1〜2文で記す。
- 重複統合（冗長性10%以下）、用語は原文準拠、思考過程は出力しない。
- 非機能の観点も抽出し、可能なものは業務フロー上で検証可能な形に要点化。
```

### 2.2 User Prompt（テンプレート）

```
# タスク
以下のソース文書を読み、テスト観点を抽出して構造化してください。

# 入力
<docs>{{DOCS_BLOCK}}</docs>
<scope>{{SCOPE_BLOCK}}</scope>

# 出力要件
1) JSON（rules.md準拠、スキーマ記述は不要）
2) Markdown（テーブル: vp_id, title, feature, test_class, risk, priority, source）

# 粒度と網羅
- 各主機能につき normal / quasi / abnormal を最低1件ずつ。
- 前提・期待の要点は簡潔に（各1〜2文）。
- 非機能（入力制限、権限、メッセージ整合、タイムアウト等）も適切に含める。

# リスク評価の簡約
- impact: 1=軽微, 2=一部機能, 3=主要機能, 4=業務停止, 5=重大（法令/金銭）
- likelihood: 1=稀, 2=低, 3=中, 4=高, 5=恒常的
- raw=impact*likelihood を 1–25 → 1–5 へ丸め（rules.mdの丸め表に従う）
- priority: score≥4 または監査/決済/法令関連=High, score=3=Med, score≤2=Low

# 品質チェック
- 出典必須。観点タイトルはユニーク。主語（actor）と機能名は原文準拠。
- 類似は統合。normal/quasi/abnormal の欠落があれば補完。
```

**差し替えパラメータ**

* `{{DOCS_BLOCK}}`：doc_id/章節/抜粋テキストの列挙
* `{{SCOPE_BLOCK}}`：actors, in/out of scope, 非機能ヒント

---

## 3. 実行アルゴリズム（LLMが辿る手順）

1. **対象スコープの要約（100〜150字）**
2. **アクター×機能マトリクスの下書き**（欠落検知の土台）
3. **章節走査→観点候補抽出**（doc_id/section/pageを同時付与）
4. **分類付与**：`normal` / `quasi` / `abnormal`
5. **リスク見積り**：impact/likelihood→`risk_score` 丸め＋ `risk_detail`
6. **重複統合＆用語正規化**（原文準拠）
7. **優先度付与**（既定ルール）
8. **品質チェック**（欠落・出典・ユニーク性・冗長性≤10%）
9. **JSON→Markdown生成**（順に出力）

---

## 4. Few-shot：入力断片 → 期待出力の例（JSONは省略）

### 4.1 例A：ログイン（抜粋）

**入力抜粋（擬似）**

```
DOC-OPS-001 §3.2 (p.12-13)
- ユーザーIDとパスワードでログインする。5回連続失敗でロック（15分）。
- パスワードは8～64桁。大文字/小文字/数字を含むこと。
- ログイン後はダッシュボードへ遷移。ロールに応じ機能が変化。
- エラーメッセージは「IDまたはパスワードが正しくありません」。
```

**期待されるMarkdown（表）**

```markdown
| vp_id  | title                         | feature | test_class | risk | priority | source                     |
|--------|--------------------------------|---------|------------|------|----------|----------------------------|
| VP-001 | 有効資格情報でのログイン成功   | ログイン | normal     | 3    | Med      | DOC-OPS-001 §3.2 p.12      |
| VP-002 | 連続失敗時のロック発動と解除   | ログイン | quasi      | 4    | High     | DOC-OPS-001 §3.2 p.13      |
| VP-003 | パスワードポリシー逸脱の拒否   | ログイン | abnormal   | 4    | High     | DOC-OPS-001 §3.2 p.12      |
```

**各観点の要点（箇条書き）**

* VP-001：前提=有効ユーザー、期待=ダッシュボード表示＋ロール反映、出典=§3.2 p.12
* VP-002：前提=無効資格情報、期待=5回でロック→15分解除、出典=§3.2 p.13
* VP-003：前提=PW変更可能、期待=要件外PWを拒否し適切メッセージ、出典=§3.2 p.12

---

### 4.2 例B：受注登録（抜粋）

**入力抜粋（擬似）**

```
DOC-SRS-002 §5.1 (p.44-47)
- 受注は顧客・品目・数量・単価が必須。通貨は会社既定。最大行数は100。
- 在庫が不足する場合は警告表示の上、保存は可能。出荷時点で不足は禁止。
- 単価が0は不可。割引率は0〜50%。
```

**期待されるMarkdown（表）**

```markdown
| vp_id  | title                       | feature | test_class | risk | priority | source                     |
|--------|------------------------------|---------|------------|------|----------|----------------------------|
| VP-010 | 必須項目を満たす受注の登録   | 受注登録 | normal     | 3    | Med      | DOC-SRS-002 §5.1 p.44      |
| VP-012 | 在庫不足時の警告と保存許可   | 受注登録 | quasi      | 4    | High     | DOC-SRS-002 §5.1 p.46      |
| VP-013 | 単価ゼロや割引率超過の拒否   | 受注登録 | abnormal   | 4    | High     | DOC-SRS-002 §5.1 p.45      |
```

---

## 5. 品質検収チェックリスト

* [ ] 主機能ごとに **normal/quasi/abnormal >= 1**
* [ ] `source_refs` が**全観点に付与**
* [ ] タイトルがユニーク／冗長性 ≤ 10%
* [ ] `risk_score` と `priority` が規約どおり
* [ ] 非機能の観点が最低1つ以上（該当機能に応じて）
* [ ] 用語が原文準拠（画面名・役割名）
* [ ] 前提と期待が簡潔（各1〜2文）

---

## 6. 失敗パターンと回避策

* **normal だけ量産** → 先に準正常・異常の候補を列挙してから観点化。
* **出典欠落** → 章節走査段階で doc_id/section/page を**同時に**控える。
* **ケース爆発** → データバリエーションは後段で束ね、観点は「性質の塊」でまとめる。

---

## 7. 実行例テンプレ（貼り替えて使う）

### 7.1 変数ブロック作成（人手）

```yaml
DOCS_BLOCK: |
  - { doc_id: "DOC-OPS-001", title: "運用手順 v1.4", section: "§3.2", page: "12-13", excerpt: "..." }
  - { doc_id: "DOC-SRS-002", title: "要件定義書", section: "§5.1", page: "44-47", excerpt: "..." }

SCOPE_BLOCK: |
  actors: ["一般ユーザー","管理者"]
  in_scope_features: ["ログイン","受注登録"]
  out_of_scope: ["外部決済"]
  non_functional_hints: ["入力制限","エラーメッセージ整合","タイムアウト"]
```

### 7.2 実行用プロンプト（User）

> 上記の **2.2 User Prompt** に、この `DOCS_BLOCK` と `SCOPE_BLOCK` を差し込んで送る。

---

## 8. 出力の後処理（任意）

* 観点の `feature` をキーにピボットして、**主機能×test_class** の穴を確認。
* `risk_score≥4` を抽出して **優先観点セット** を作る。
* これらを `test_scenario_design_guide.md` に渡して、業務シナリオへ束ねる。

---

## 9. 注意（出力ポリシー）

* 逐語的な思考や内部推論は出力しない。
* 不明点が多い場合は、**不足情報リスト**を末尾に箇条書きで示す（例：「決済ゲートウェイ仕様が未提供」）。
